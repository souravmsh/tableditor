/**
 * @name TablEditor
 * @description Inline editor for HTML tables compatible with Bootstrap 
 * @author Shohrab Hossain <sourav.diubd@gmail.com>
 * @version 1.1.0
 * @copyright (c) 2024  
*/
if("undefined"==typeof jQuery)throw Error("TablEditor requires jQuery library.");!function(t){"use strict";t.fn.TablEditor=function(e){if(!this.is("table"))throw Error("TablEditor only works when applied to a table.");var i=this,a={url:window.location.href,inputClass:"form-control input-sm",groupClass:"btn-group btn-group-sm",dangerClass:"table-danger",warningClass:"table-warning",paginationClass:"page-link",deleteBtnClass:"",editBtnClass:"",refreshBtnClass:"",eventType:"click",columns:{identifier:[0,"id"],editable:[]},onSuccess:function(){},onFail:function(){},onAlways:function(){},onAjax:function(){}},n=t.extend(!0,a,e),l=!1,d={columns:{identifier:function(){i.find("thead th:nth-child(1)").html('<input type="checkbox" class="tableditable-check-all" value="all"/>');var e=i.find("tbody td:nth-child("+(parseInt(n.columns.identifier[0])+1)+")");if(e.length<0)return!1;e.each(function(){var e='<input class="editable-identifier tableditable-check" type="checkbox" name="'+n.columns.identifier[1]+'[]" value="'+t(this).closest("tr").data("id")+'" >';t(this).html(e)})},editable:function(){for(var e=0;e<n.columns.editable.length;e++)i.find("tbody td:nth-child("+(parseInt(n.columns.editable[e][0])+1)+")").each(function(){var i=t(this).text().trim();n.editButton||t(this).css("cursor","pointer");var a='<span class="tableditable-span" data-name="'+n.columns.editable[e][1]+'" data-value="'+i+'">'+i+"</span>",l='<input class="tableditable-input '+n.inputClass+'" type="text" name="'+n.columns.editable[e][1]+'" value="'+i+'" style="max-width:160px;display: none;" disabled>',d="";if(void 0!==n.columns.editable[e][2])d+='<div style="position:relative;display:block;width:100%;">',d+='<ul class="tableditable-combobox" style="max-width:160px;max-height:150px;position:absolute;top:2px;left:0;box-sizing:border-box;border:1px solid #ccc;border-top:none;overflow-y:auto;background-color:white;z-index:1;display:none;margin: 0;padding:0;list-style:none">',d+='<li style="padding:3px 6px;cursor:pointer"><input type="text" class="tableditable-filter '+n.inputClass+'" placeholder="Search..." style="width:100%;box-sizing:border-box;padding:3px 6px"></li>',t.each(jQuery.parseJSON(n.columns.editable[e][2]),function(t,o){i===o?(a='<span class="tableditable-span" data-name="'+n.columns.editable[e][1]+'"  data-value="'+t+'">'+o+"</span>",l='<input class="tableditable-input '+n.inputClass+'" type="text" name="'+n.columns.editable[e][1]+'" value="'+o+'" style="max-width:160px;display: none;" disabled readonly>',d+='<li data-value="'+t+'" class="tableditable-li" style="padding:3px 6px;cursor:pointer;background:#e1e1e1" data-selected="true">'+o+"</li>"):d+='<li data-value="'+t+'" class="tableditable-li" style="padding:3px 6px;cursor:pointer">'+o+"</li>"}),d+="</ul>",d+="</div>";else var l='<input class="tableditable-input '+n.inputClass+'" type="text" name="'+n.columns.editable[e][1]+'" value="'+t(this).text()+'" style="max-width:160px;display: none;" autocomplete="off" disabled>';t(this).html(a+l+d),t(this).addClass("tableditable-view-mode")})}},modal:function(e,i,a){var n=t('<div class="editable-modal"><h4 style="color:#fff">'+e+'</h4><hr style="border-bottom:1px solid #fff"/>').css({position:"fixed",top:"40%",left:"50%",transform:"translate(-50%, -50%)","background-color":"#5156be",color:"#f3f8fb",padding:"20px",border:"1px solid #ccc","box-shadow":"0 0 10px rgba(0, 0, 0, 0.1)","z-index":"9999"}),l=t("<div>").css({"margin-bottom":"10px"}).html(i),d=t('<div class="buttons">').css({"text-align":"right"}),o=t('<button class="cancel">Cancel</button>').css({"margin-left":"10px"}),s=t('<button class="continue">Continue</button>');d.append(s,o),n.append(l,d),t("body").append(n),n.show(),s.on("click",function(){"function"==typeof a&&a(),n.remove()}),o.on("click",function(){n.remove()})}};d.columns.identifier(),d.columns.editable();var o={view:function(e){t(e).parent("tr"),t(e).find(".tableditable-input").blur().hide(),t(e).find(".tableditable-input").prop("disabled",!0),t(e).find(".tableditable-combobox").blur().hide(),t(e).find(".tableditable-span").show(),t(e).addClass("tableditable-view-mode").removeClass("tableditable-edit-mode")},edit:function(e){t(e).parent("tr");var i=t(e).find(".tableditable-input");i.length&&(i.prop("disabled",!1).show(),n.autoFocus&&i.focus(),t(e).find(".tableditable-span").hide());var a=t(e).find(".tableditable-combobox");a.length&&a.show(),t(e).addClass("tableditable-edit-mode").removeClass("tableditable-view-mode")}},s={reset:function(e){t(e).each(function(){var e=t(this).find(".tableditable-span").text(),i=t(this).find(".tableditable-input");t(this).find(".tableditable-combobox").is("ul")?t(this).find("input").not("input.tableditable-filter").val(e.trim()):i.is("input")&&i.val(e.trim()),o.view(this)})},submit:function(e){var a=[];if("delete"==e?i.find(".tableditable-check:checked").each(function(){var e={};e[n.columns.identifier[1]]=t(this).val(),a.push(e)}):"edit"==e&&i.find(".tableditable-check:checked:disabled").each(function(){var e=t(this).closest("tr"),i={};i[n.columns.identifier[1]]=t(this).val(),e.find("td").each(function(e,a){var n=t(a).find(".tableditable-span");if(n.length>0){var l=n.data("name"),d=n.data("value");i[l]=d}}),a.push(i)}),!1===function e(i,a=[]){if(!a||!1===n.onAjax(i,a))return!1;var l=t.post(n.url,{action:i,data:a},function(t,e,i){n.onSuccess(t,e,i)},"json");return l.fail(function(t,e,i){n.onFail(t,e,i)}),l.always(function(){n.onAlways()}),l}(e,a))return}};i.on(n.eventType,"td.tableditable-view-mode",function(t){!0!==t.handled&&(t.preventDefault(),s.reset(i.find("td.tableditable-edit-mode")),o.edit(this),t.handled=!0)}),t(document).on("click",function(t){var e=i.find(".tableditable-edit-mode");e.is(t.target)||0!==e.has(t.target).length||(s.reset(e.parent("td")),s.reset(i.find(".tableditable-input:visible").parent("td")))}),i.on("keyup",function(e){l=!0;var i=t(e.target).closest("td");switch(i.find(".tableditable-combobox").length||(i.find(".tableditable-input").val(e.target.value.trim()),i.find(".tableditable-span").text(e.target.value.trim()),i.find(".tableditable-span").attr("data-value",e.target.value.trim())),i.closest("tr").addClass(n.dangerClass),i.closest("tr").find("input.tableditable-check").prop("checked",!0).prop("disabled",!0),c.edit(),e.keyCode){case 9:o.view(i),o.edit(i.next());break;case 27:s.reset(i)}}),i.on("keyup","ul.tableditable-combobox input.tableditable-filter",function(){let e=t(this).val().toLowerCase(),i=t(this).closest("ul.tableditable-combobox").find("li.tableditable-li");i.each(function(){t(this).text().toLowerCase().indexOf(e)>-1?t(this).show():t(this).hide()})}),i.on("click","ul.tableditable-combobox li.tableditable-li",function(e){if(e.stopPropagation(),!0!==e.handled){e.handled=!0,t(this).closest("ul").find("li").css("background","");var i=t(this).closest("td"),a=t(this).text(),d=t(this).data("value");t(this).css({background:"#e1e1e1"}),i.find(".tableditable-span").text(a),i.find(".tableditable-span").attr("data-value",d),i.find("input").not("input.tableditable-filter").val(a.trim()),i.closest("tr").addClass(n.dangerClass),i.closest("tr").find("input.tableditable-check").prop("checked",!0).prop("disabled",!0),t(this).closest("ul").find("input.tableditable-filter").val(""),t(this).closest("ul").find("li").show(),l=!0,o.view(i),c.edit()}});var c={refresh:function(){t("."+n.refreshBtnClass).length&&t("."+n.refreshBtnClass).prop("disabled",!1)},edit:function(){if(l){var t=i.find("input.tableditable-check:checked").length;this.updateButton(n.editBtnClass,`Update ${t} Items`,t)}},delete:function(){var t=i.find("input.tableditable-check:checked").length;this.updateButton(n.deleteBtnClass,`Delete ${t} Items`,t)},updateButton:function(e,i,a){t("."+e).length&&t("."+e).text(i).prop("disabled",0===a)}};c.refresh(),t("body").on("click","."+n.refreshBtnClass,function(){window.location.reload()}),t("body").on("click","."+n.deleteBtnClass,function(){d.modal("Confirmation Required","Are you sure you want to delete these item?<br/>This action cannot be undone.",function(){s.submit("delete")})}),t("body").on("click","."+n.editBtnClass,function(){d.modal("Confirmation Required","Are you sure you want to update these items?<br/>This action cannot be undone.",function(){s.submit("edit")})});var r=i.find("input.tableditable-check-all"),b=i.find("input.tableditable-check");return r.on("change",function(){b.not(":disabled").prop("checked",t(this).prop("checked")),c.delete()}),b.on("change",function(){r.prop("checked",b.length===b.filter(":checked").length),c.delete()}),t("body").on("click",n.paginationClass?"."+n.paginationClass:"",function(t){if(l){t.preventDefault(),t.stopPropagation();var e="You have unsaved changes to "+b.filter(":checked").length+' items. Please save before leaving.<br/>Click "Continue" to proceed without saving, or "Cancel" to stay and save changes.';d.modal("Are you sure?",e,function(){window.location.href=t.target.href})}}),this}}(jQuery);
