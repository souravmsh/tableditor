/**
 * @name TableEditor - v1.0.0
 * @description Inline editor for HTML tables compatible with Bootstrap 
 * @author Shohrab Hossain <sourav.diubd@gmail.com>
 * @version 1.0.0
 * @copyright (c) 2024 
 * @inspiredBy https://github.com/markcell/jQuery-Tabledit
 */
if("undefined"==typeof jQuery)throw new Error("TableEditor requires jQuery library.");var e;(e=jQuery).fn.TableEditor=function(t){if(!this.is("table"))throw new Error("TableEditor only works when applied to a table.");var n=this,i={url:window.location.href,inputClass:"form-control input-sm",groupClass:"btn-group btn-group-sm",dangerClass:"table-danger",warningClass:"table-warning",paginationClass:"page-link",deleteBtnClass:"",editBtnClass:"",refreshBtnClass:"",eventType:"click",columns:{identifier:[0,"id"],editable:[]},onSuccess:function(){},onFail:function(){},onAlways:function(){},onAjax:function(){}},a=e.extend(!0,i,t),d=!1,o={identifier:function(){n.find("thead th:nth-child(1)").html('<input type="checkbox" class="editable-check-all" value="all"/>');var t=n.find("tbody td:nth-child("+(parseInt(a.columns.identifier[0])+1)+")");if(t.length<=1)return!1;t.each((function(){var t='<input class="editable-identifier editable-check" type="checkbox" name="'+a.columns.identifier[1]+'[]" value="'+e(this).closest("tr").data("id")+'" >';e(this).html(t)}))},editable:function(){for(var t=0;t<a.columns.editable.length;t++)n.find("tbody td:nth-child("+(parseInt(a.columns.editable[t][0])+1)+")").each((function(){var n=e(this).text();a.editButton||e(this).css("cursor","pointer");var i='<span class="editable-span" data-name="'+a.columns.editable[t][1]+'">'+n+"</span>";if("undefined"!=typeof a.columns.editable[t][2]){var d='<select class="editable-input '+a.inputClass+'" name="'+a.columns.editable[t][1]+'" style="display: none;" disabled>';e.each(jQuery.parseJSON(a.columns.editable[t][2]),(function(e,t){d+=n===t?'<option value="'+e+'" selected>'+t+"</option>":'<option value="'+e+'">'+t+"</option>"})),d+="</select>"}else d='<input class="editable-input '+a.inputClass+'" type="text" name="'+a.columns.editable[t][1]+'" value="'+e(this).text()+'" style="display: none;" autocomplete="off" disabled>';e(this).html(i+d),e(this).addClass("editable-view-mode")}))}},Draw_modal=function(t,n,i){var a=e('<div class="editable-modal"><h4 style="color:#fff">'+t+'</h4><hr style="border-bottom:1px solid #fff"/>').css({position:"fixed",top:"40%",left:"50%",transform:"translate(-50%, -50%)","background-color":"#5156be",color:"#f3f8fb",padding:"20px",border:"1px solid #ccc","box-shadow":"0 0 10px rgba(0, 0, 0, 0.1)","z-index":"9999"}),d=e("<div>").css({"margin-bottom":"10px"}).html(n),o=e('<div class="buttons">').css({"text-align":"right"}),l=e('<button class="cancel">Cancel</button>').css({"margin-left":"10px"}),s=e('<button class="continue">Continue</button>');o.append(s,l),a.append(d,o),e("body").append(a),a.show(),s.on("click",(function(){"function"==typeof i&&i(),a.remove()})),l.on("click",(function(){a.remove()}))};o.identifier(),o.editable();var Mode_view=function(t){e(t).parent("tr"),e(t).find(".editable-input").blur().hide().prop("disabled",!0),e(t).find(".editable-span").show(),e(t).addClass("editable-view-mode").removeClass("editable-edit-mode")},Mode_edit=function(t){e(t).parent("tr"),e(t).find(".editable-span").hide();var n=e(t).find(".editable-input");n.prop("disabled",!1).show(),a.autoFocus&&n.focus(),e(t).addClass("editable-edit-mode").removeClass("editable-view-mode")},Form_reset=function(t){e(t).each((function(){var t=e(this).find(".editable-input"),n=e(this).find(".editable-span").text();t.is("select")?t.find("option").filter((function(){return e.trim(e(this).text())===n})).attr("selected",!0):t.val(n),Mode_view(this)}))},Form_submit=function(t){var i=[];"delete"==t?n.find(".editable-check:checked").each((function(){var t={};t[a.columns.identifier[1]]=e(this).val(),i.push(t)})):"edit"==t&&n.find(".editable-check:checked:disabled").each((function(){var t=e(this).closest("tr"),n={};n[a.columns.identifier[1]]=e(this).val(),t.find("td").each((function(t,i){var a=e(i).find(".editable-span");if(a.length>0){var d=a.data("name"),o=a.text().trim();n[d]=o}})),i.push(n)})),function ajax(t,n=[]){if(!n)return!1;var i=a.onAjax(t,n);if(!1===i)return!1;var d={action:t,data:n},o=e.post(a.url,d,(function(e,t,n){a.onSuccess(e,t,n)}),"json");return o.always((function(){a.onAlways()})),o}(t,i)};n.on(a.eventType,"td.editable-view-mode",(function(e){!0!==e.handled&&(e.preventDefault(),Form_reset(n.find("td.editable-edit-mode")),Mode_edit(this),e.handled=!0)})),n.on("change","select.editable-input:visible",(function(t){if(!0!==t.handled){var n=e(this).parent("td");t.handled=!0,n.find(".editable-input").val(t.target.value),n.find(".editable-span").text(t.target.value),n.closest("tr").addClass(a.dangerClass),n.closest("tr").find("input.editable-check").prop("checked",!0).prop("disabled",!0),d=!0,l.edit()}})),e(document).on("click",(function(e){var t=n.find(".editable-edit-mode");t.is(e.target)||0!==t.has(e.target).length||Form_reset(n.find(".editable-input:visible").parent("td"))})),n.on("keyup",(function(e){var t=n.find(".editable-input:visible"),i=n.find(".editable-confirm-button");if(t.length>0)var o=t.parents("td");else{if(!(i.length>0))return;o=i.parents("td")}switch(o.find(".editable-input").val(e.target.value),o.find(".editable-span").text(e.target.value),o.closest("tr").addClass(a.dangerClass),o.closest("tr").find("input.editable-check").prop("checked",!0).prop("disabled",!0),d=!0,l.edit(),e.keyCode){case 9:Mode_edit(o.closest("td").next());break;case 27:Form_reset(o)}}));var l={refresh:function(){e("."+a.refreshBtnClass).length&&e("."+a.refreshBtnClass).prop("disabled",!1)},edit:function(){if(d){var e=n.find("input.editable-check:checked").length;this.updateButton(a.editBtnClass,`Update ${e} Items`,e)}},"delete":function(){var e=n.find("input.editable-check:checked").length;this.updateButton(a.deleteBtnClass,`Delete ${e} Items`,e)},updateButton:function(t,n,i){e("."+t).length&&e("."+t).text(n).prop("disabled",0===i)}};l.refresh(),e("body").on("click","."+a.refreshBtnClass,(function(){window.location.reload()})),e("body").on("click","."+a.deleteBtnClass,(function(){Draw_modal("Confirmation Required","Are you sure you want to delete these item?<br/>This action cannot be undone.",(function(){Form_submit("delete")}))})),e("body").on("click","."+a.editBtnClass,(function(){Draw_modal("Confirmation Required","Are you sure you want to update these items?<br/>This action cannot be undone.",(function(){Form_submit("edit")}))}));var s=n.find("input.editable-check-all"),c=n.find("input.editable-check");return s.on("change",(function(){c.not(":disabled").prop("checked",e(this).prop("checked")),l["delete"]()})),c.on("change",(function(){s.prop("checked",c.length===c.filter(":checked").length),l["delete"]()})),e("body").on("click",a.paginationClass?"."+a.paginationClass:"",(function(e){if(d){e.preventDefault(),e.stopPropagation();var t="You have unsaved changes to "+c.filter(":checked").length+' items. Please save before leaving.<br/>Click "Continue" to proceed without saving, or "Cancel" to stay and save changes.';Draw_modal("Are you sure?",t,(function(){window.location.href=e.target.href}))}})),this};
